trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  registryServiceConnection: 'registrationappacr'
  imageRepository: 'registration'
  containerRegistry: 'registrationappacr.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)'
  tag: '$(Build.BuildId)'
  MSYS_NO_PATHCONV: 1

stages:
  - stage: BuildBackend
    displayName: 'Build Backend'
    jobs:
      - job: BuildBackendJob
        displayName: 'Build Backend Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build Backend Image'
            inputs:
              command: 'build'
              Dockerfile: '$(dockerfilePath)/backend/Dockerfile'
              repository: '$(containerRegistry)/registration-api'
              tags: |
                $(tag)
                latest
              arguments: '--build-arg BUILD_ID=$(Build.BuildId)'

          - task: Docker@2
            displayName: 'Push Backend Image'
            inputs:
              command: 'push'
              repository: '$(containerRegistry)/registration-api'
              tags: |
                $(tag)
                latest
              containerRegistry: '$(registryServiceConnection)'

  - stage: BuildFrontend
    displayName: 'Build Frontend'
    dependsOn: BuildBackend
    jobs:
      - job: BuildFrontendJob
        displayName: 'Build Frontend Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build Frontend Image'
            inputs:
              command: 'build'
              Dockerfile: '$(dockerfilePath)/frontend/Dockerfile'
              repository: '$(containerRegistry)/registration-frontend'
              tags: |
                $(tag)
                latest

          - task: Docker@2
            displayName: 'Push Frontend Image'
            inputs:
              command: 'push'
              repository: '$(containerRegistry)/registration-frontend'
              tags: |
                $(tag)
                latest
              containerRegistry: '$(registryServiceConnection)'

  - stage: DeployBackend
    displayName: 'Deploy Backend to Azure'
    dependsOn: BuildBackend
    condition: succeeded()
    jobs:
      - job: DeployBackendJob
        displayName: 'Deploy Backend Container'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Backend Container'
            inputs:
              azureSubscription: 'Azure Resource Manager'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $resourceGroup = "rg-registration-app"
                $location = "centralindia"
                $acrName = "registrationappacr"
                $acrServer = "$acrName.azurecr.io"
                $backendName = "registration-api-prod"
                $sqlServer = "regsql2807"
                $sqlDb = "RegistrationAppDb"
                $sqlUser = "sqladmin"
                $sqlPass = "YourSecurePassword123!@#"
                $tag = "$(Build.BuildId)"
                
                $acrUser = az acr credential show --resource-group $resourceGroup --name $acrName --query username -o tsv
                $acrPass = az acr credential show --resource-group $resourceGroup --name $acrName --query "passwords[0].value" -o tsv
                
                $sqlFqdn = "$sqlServer.database.windows.net"
                $connStr = "Server=tcp:$sqlFqdn,1433;Initial Catalog=$sqlDb;Persist Security Info=False;User ID=$sqlUser;Password=$sqlPass;Encrypt=True;Connection Timeout=30;"
                
                Write-Host "Deleting old backend container..."
                az container delete --resource-group $resourceGroup --name $backendName --yes 2>$null
                Start-Sleep -Seconds 3
                
                Write-Host "Deploying backend container with tag $tag..."
                az container create `
                  --resource-group $resourceGroup `
                  --name $backendName `
                  --image "$acrServer/registration-api:$tag" `
                  --cpu 1 `
                  --memory 1 `
                  --os-type Linux `
                  --registry-login-server $acrServer `
                  --registry-username $acrUser `
                  --registry-password $acrPass `
                  --ports 80 `
                  --dns-name-label "registration-api-prod" `
                  --location $location `
                  --environment-variables ASPNETCORE_ENVIRONMENT=Production "ConnectionStrings__DefaultConnection=$connStr"
                
                Start-Sleep -Seconds 5
                $backendUrl = az container show --resource-group $resourceGroup --name $backendName --query ipAddress.fqdn -o tsv
                Write-Host "Backend deployed at: http://$backendUrl"

  - stage: DeployFrontend
    displayName: 'Deploy Frontend to Azure'
    dependsOn: 
      - BuildFrontend
      - DeployBackend
    condition: succeeded()
    jobs:
      - job: DeployFrontendJob
        displayName: 'Deploy Frontend Container'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Frontend Container'
            inputs:
              azureSubscription: 'Azure Resource Manager'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $resourceGroup = "rg-registration-app"
                $location = "centralindia"
                $acrName = "registrationappacr"
                $acrServer = "$acrName.azurecr.io"
                $frontendName = "registration-frontend-prod"
                $tag = "$(Build.BuildId)"
                
                $acrUser = az acr credential show --resource-group $resourceGroup --name $acrName --query username -o tsv
                $acrPass = az acr credential show --resource-group $resourceGroup --name $acrName --query "passwords[0].value" -o tsv
                
                $backendUrl = az container show --resource-group $resourceGroup --name "registration-api-prod" --query ipAddress.fqdn -o tsv
                
                Write-Host "Deleting old frontend container..."
                az container delete --resource-group $resourceGroup --name $frontendName --yes 2>$null
                Start-Sleep -Seconds 3
                
                Write-Host "Deploying frontend container with tag $tag..."
                az container create `
                  --resource-group $resourceGroup `
                  --name $frontendName `
                  --image "$acrServer/registration-frontend:$tag" `
                  --cpu 0.5 `
                  --memory 0.5 `
                  --os-type Linux `
                  --registry-login-server $acrServer `
                  --registry-username $acrUser `
                  --registry-password $acrPass `
                  --ports 80 `
                  --dns-name-label "registration-frontend-prod" `
                  --location $location `
                  --environment-variables "BACKEND_URL=http://$backendUrl"
                
                Start-Sleep -Seconds 5
                $frontendUrl = az container show --resource-group $resourceGroup --name $frontendName --query ipAddress.fqdn -o tsv
                
                Write-Host ""
                Write-Host "========== DEPLOYMENT COMPLETE ==========" -ForegroundColor Green
                Write-Host "Frontend: http://$frontendUrl" -ForegroundColor Yellow
                Write-Host "Backend:  http://$backendUrl" -ForegroundColor Yellow
                Write-Host "API:      http://$backendUrl/api/items" -ForegroundColor Yellow
                Write-Host "Swagger:  http://$backendUrl/swagger/index.html" -ForegroundColor Yellow
