version: "3.9"

services:
  # .NET Core Backend API (Production)
  registration-api-prod:
    image: registrationappacr.azurecr.io/registration-api-prod:latest
    container_name: registrationapp-backend-prod
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:80
      # Azure SQL Database connection
      ConnectionStrings__DefaultConnection: "${AZURE_SQL_CONNECTION_STRING}"
      # Azure Service Bus
      ConnectionStrings__AzureServiceBus: "${AZURE_SERVICEBUS_CONNECTION_STRING}"
      # Azure Storage
      ConnectionStrings__AzureStorageAccount: "${AZURE_STORAGE_CONNECTION_STRING}"
      # Azure Cosmos DB
      ConnectionStrings__AzureCosmosDb: "${AZURE_COSMOSDB_CONNECTION_STRING}"
      # Application Insights
      APPLICATIONINSIGHTS_CONNECTION_STRING: "${APPLICATIONINSIGHTS_CONNECTION_STRING}"
    ports:
      - "80:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/items"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Angular Frontend (Production)
  registration-frontend-prod:
    image: registrationappacr.azurecr.io/registration-frontend-prod:latest
    container_name: registrationapp-frontend-prod
    environment:
      - BACKEND_URL=http://registration-api-prod.centralindia.azurecontainer.io
    ports:
      - "80:80"
    depends_on:
      - registration-api-prod
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
