trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  containerRegistry: 'registrationappacr.azurecr.io'
  acrName: 'registrationappacr'
  resourceGroup: 'rg-registration-app'
  tag: '$(Build.BuildId)'

stages:
  - stage: BuildBackend
    displayName: 'Build Backend'
    jobs:
      - job: BuildBackendJob
        displayName: 'Build Backend Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Build and Push Backend Image'
            inputs:
              azureSubscription: 'Azure Resource Manager'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name $(acrName)
                docker build -f backend/Dockerfile -t $(containerRegistry)/registration-api:$(tag) -t $(containerRegistry)/registration-api:latest ./backend
                docker push $(containerRegistry)/registration-api:$(tag)
                docker push $(containerRegistry)/registration-api:latest
                Write-Host "Backend image pushed successfully"

  - stage: BuildFrontend
    displayName: 'Build Frontend'
    dependsOn: BuildBackend
    condition: succeeded()
    jobs:
      - job: BuildFrontendJob
        displayName: 'Build Frontend Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Build and Push Frontend Image'
            inputs:
              azureSubscription: 'Azure Resource Manager'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az acr login --name $(acrName)
                docker build -f frontend/Dockerfile -t $(containerRegistry)/registration-frontend:$(tag) -t $(containerRegistry)/registration-frontend:latest ./frontend
                docker push $(containerRegistry)/registration-frontend:$(tag)
                docker push $(containerRegistry)/registration-frontend:latest
                Write-Host "Frontend image pushed successfully"

  - stage: DeployBackend
    displayName: 'Deploy Backend to Azure'
    dependsOn: BuildBackend
    condition: succeeded()
    jobs:
      - job: DeployBackendJob
        displayName: 'Deploy Backend Container'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Backend Container'
            inputs:
              azureSubscription: 'Azure Resource Manager'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $resourceGroup = "$(resourceGroup)"
                $location = "centralindia"
                $acrName = "$(acrName)"
                $acrServer = "$(containerRegistry)"
                $backendName = "registration-api-prod"
                $sqlServer = "regsql2807"
                $sqlDb = "RegistrationAppDb"
                $sqlUser = "sqladmin"
                $sqlPass = "YourSecurePassword123!@#"
                $tag = "$(tag)"
                
                $acrUser = az acr credential show --resource-group $resourceGroup --name $acrName --query username -o tsv
                $acrPass = az acr credential show --resource-group $resourceGroup --name $acrName --query "passwords[0].value" -o tsv
                
                $sqlFqdn = "$sqlServer.database.windows.net"
                $connStr = "Server=tcp:$sqlFqdn,1433;Initial Catalog=$sqlDb;Persist Security Info=False;User ID=$sqlUser;Password=$sqlPass;Encrypt=True;Connection Timeout=30;"
                
                Write-Host "Deleting old backend container..."
                az container delete --resource-group $resourceGroup --name $backendName --yes 2>$null
                Start-Sleep -Seconds 3
                
                Write-Host "Deploying backend container with tag $tag..."
                az container create `
                  --resource-group $resourceGroup `
                  --name $backendName `
                  --image "$acrServer/registration-api:$tag" `
                  --cpu 1 `
                  --memory 1 `
                  --os-type Linux `
                  --registry-login-server $acrServer `
                  --registry-username $acrUser `
                  --registry-password $acrPass `
                  --ports 80 `
                  --dns-name-label "registration-api-prod" `
                  --location $location `
                  --environment-variables ASPNETCORE_ENVIRONMENT=Production "ConnectionStrings__DefaultConnection=$connStr"
                
                Start-Sleep -Seconds 5
                $backendUrl = az container show --resource-group $resourceGroup --name $backendName --query ipAddress.fqdn -o tsv
                Write-Host "##vso[task.setvariable variable=BACKEND_URL]$backendUrl"
                Write-Host "Backend deployed at: http://$backendUrl"

  - stage: DeployFrontend
    displayName: 'Deploy Frontend to Azure'
    dependsOn: 
      - BuildFrontend
      - DeployBackend
    condition: succeeded()
    jobs:
      - job: DeployFrontendJob
        displayName: 'Deploy Frontend Container'
        steps:
          - task: AzureCLI@2
            displayName: 'Deploy Frontend Container'
            inputs:
              azureSubscription: 'Azure Resource Manager'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                $resourceGroup = "$(resourceGroup)"
                $location = "centralindia"
                $acrName = "$(acrName)"
                $acrServer = "$(containerRegistry)"
                $frontendName = "registration-frontend-prod"
                $tag = "$(tag)"
                
                $acrUser = az acr credential show --resource-group $resourceGroup --name $acrName --query username -o tsv
                $acrPass = az acr credential show --resource-group $resourceGroup --name $acrName --query "passwords[0].value" -o tsv
                
                $backendUrl = az container show --resource-group $resourceGroup --name "registration-api-prod" --query ipAddress.fqdn -o tsv
                
                Write-Host "Deleting old frontend container..."
                az container delete --resource-group $resourceGroup --name $frontendName --yes 2>$null
                Start-Sleep -Seconds 3
                
                Write-Host "Deploying frontend container with tag $tag..."
                az container create `
                  --resource-group $resourceGroup `
                  --name $frontendName `
                  --image "$acrServer/registration-frontend:$tag" `
                  --cpu 0.5 `
                  --memory 0.5 `
                  --os-type Linux `
                  --registry-login-server $acrServer `
                  --registry-username $acrUser `
                  --registry-password $acrPass `
                  --ports 80 `
                  --dns-name-label "registration-frontend-prod" `
                  --location $location `
                  --environment-variables "BACKEND_URL=http://$backendUrl"
                
                Start-Sleep -Seconds 5
                $frontendUrl = az container show --resource-group $resourceGroup --name $frontendName --query ipAddress.fqdn -o tsv
                
                Write-Host ""
                Write-Host "========== DEPLOYMENT COMPLETE ==========" 
                Write-Host "Frontend: http://$frontendUrl"
                Write-Host "Backend:  http://$backendUrl"
                Write-Host "API:      http://$backendUrl/api/items"
                Write-Host "Swagger:  http://$backendUrl/swagger/index.html"